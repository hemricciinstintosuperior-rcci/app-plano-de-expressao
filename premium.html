<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório Premium</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{ font-family: "Times New Roman", serif; color:#111; background:#f4f4f4; line-height:1.8; margin:0; }
body > *{ max-width:1350px; margin-left:auto; margin-right:auto; padding-left:40px; padding-right:40px; }

.capa{ text-align:center; padding-top:100px; padding-bottom:100px; background:white; box-shadow:0 0 25px rgba(0,0,0,0.05); border-radius:10px; page-break-after: always; }
.logo{ max-width:700px; margin-bottom:50px; }
.secao { page-break-inside: avoid; background:white; padding:20px 10px; margin-top:40px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.05); }

h2{ font-size:32px; margin-bottom:25px; border-bottom:1px solid #eee; padding-bottom:10px; }
.nomeCliente{ margin-top:70px; font-size:32px; }
.subtitulo{ font-size:50px; color:#191F42; }

/* ESTILOS DAS BARRAS */
.grafico{ margin-top:20px; }
.barra{ margin:18px 0; }
.barra span{ font-weight:bold; display:block; margin-bottom:6px; font-size: 18px; }
.linha{ width:100%; height:14px; background:#eee; border-radius:20px; overflow:hidden; }
.preenchimento{ display:block; height:14px; border-radius:20px; }

/* CORES */
.fisico{ background:#ef4444; }
.mental{ background:#06b6d4; }
.emocional{ background:#22c55e; }
.intuitivo{ background:#eab308; }
.criativo { background: #a855f7; } 
.indeciso { background: #f97316; } 
.neutro { background: #94a3b8; }

.texto-grande {
    margin-top: 25px;
    padding: 20px;
    background: #f9fafb;
    border-left: 5px solid #a855f7;
    font-style: italic;
    white-space: pre-wrap; /* Mantém as quebras de linha das crases */
}

.rodape{ margin-top:60px; margin-bottom:40px; text-align:center; font-size:20px; }

@media print {
    .linha { background-color: #eee !important; }
    .fisico { background-color: #ef4444 !important; }
    .mental { background-color: #06b6d4 !important; }
    .emocional { background-color: #22c55e !important; }
    .intuitivo { background-color: #eab308 !important; }
    .criativo { background-color: #a855f7 !important; }
    .indeciso { background-color: #f97316 !important; }
    .neutro { background-color: #94a3b8 !important; }
}

 0/* Forçar a impressão de cores de fundo sem depender da ação do usuário */
* {
    -webkit-print-color-adjust: exact !important; /* Para Chrome, Edge e Safari */
    print-color-adjust: exact !important;         /* Para Firefox */
    color-adjust: exact !important;               /* Padrão antigo */
}

/* Garante que as barras especificamente mantenham as cores no PDF */
.fisico { background-color: #ef4444 !important; }
.mental { background-color: #06b6d4 !important; }
.emocional { background-color: #22c55e !important; }
.intuitivo { background-color: #eab308 !important; }
.criativo { background-color: #a855f7 !important; }
.indeciso { background-color: #f97316 !important; }
.neutro { background-color: #94a3b8 !important; }   

 /* ESTILO DAS BARRAS OTIMIZADO PARA CELULAR */
.linha {
    width: 100%;
    height: 14px;
    background-color: #eee !important;
    border-radius: 20px;
    margin: 4px 0;
    /* Força a cor de fundo no celular */
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
}

.preenchimento {
    height: 14px;
    border-radius: 20px;
    display: block;
    /* Truque: o PDF do celular reconhece sombras internas como cor mesmo sem "gráficos de fundo" */
    box-shadow: inset 0 0 0 1000px; 
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
}

/* Cores aplicadas via Shadow para garantir exibição no Mobile */
.fisico { color: #ef4444 !important; background-color: #ef4444 !important; }
.mental { color: #06b6d4 !important; background-color: #06b6d4 !important; }
.emocional { color: #22c55e !important; background-color: #22c55e !important; }
.intuitivo { color: #eab308 !important; background-color: #eab308 !important; }
.criativo { color: #a855f7 !important; background-color: #a855f7 !important; }
.indeciso { color: #f97316 !important; background-color: #f97316 !important; }
.neutro { color: #94a3b8 !important; background-color: #94a3b8 !important; }

/* Evita quebras de página ruins no meio das barras no celular */
.barra {
    page-break-inside: avoid;
    break-inside: avoid;
    margin-bottom: 15px;
}   
</style>
</head>

<body>
<div id="conteudo">Carregando relatório premium...</div>

<script>
const dadosSalvos = localStorage.getItem("relatorioMapa");
if(!dadosSalvos){
    document.getElementById("conteudo").innerHTML = "<p>Erro: Nenhum mapa encontrado.</p>";
} else {
    const rel = JSON.parse(dadosSalvos);
    const dataBr = rel.data.split('-').reverse().join('/');

    // Função de cálculo de porcentagem (Tabela 3 utiliza os valores brutos enviados)
    const calcPct = (val, max) => Math.round((val / max) * 100) || 0;

    const maxNat = Math.max(rel.fisico, rel.mental, rel.emocional, rel.intuitivo);
    const maxExpNat = Math.max(rel.criativoNat, rel.indecisoNat, rel.neutroNat);

    const maxMom = Math.max(rel.fisicoMomento, rel.mentalMomento, rel.emocionalMomento, rel.intuitivoMomento);
    const maxExpMom = Math.max(rel.criativoMom, rel.indecisoMom, rel.neutroMom);

    document.getElementById("conteudo").innerHTML = `
    <div class="capa">
        <img class="logo" src="https://raw.githubusercontent.com/hemricciinstintosuperior-rcci/app-plano-de-expressao/main/icon-192.png">
        <div class="nomeCliente"><strong>${rel.nome}</strong><br>${dataBr}</div>
        <div class="subtitulo">"Sua jornada de autoconhecimento começa aqui."</div>
    </div>

    <div class="secao">
        <h2>Plano de Expressão Natural</h2>
        <div class="grafico">
            ${gerarBarra("Físico", rel.fisico, maxNat, 'fisico')}
            ${gerarBarra("Mental", rel.mental, maxNat, 'mental')}
            ${gerarBarra("Emocional", rel.emocional, maxNat, 'emocional')}
            ${gerarBarra("Intuitivo", rel.intuitivo, maxNat, 'intuitivo')}
        </div>
        <p style="white-space:pre-line;">${rel.textoNatural}</p>

        <h3>Perfil de Expressão (Natural)</h3>
        <div class="grafico">
            ${gerarBarra("Criativo", rel.criativoNat, maxExpNat, 'criativo')}
            ${gerarBarra("Indeciso", rel.indecisoNat, maxExpNat, 'indeciso')}
            ${gerarBarra("Neutro", rel.neutroNat, maxExpNat, 'neutro')}
        </div>
        <div class="texto-grande">${rel.textoExpressaoNat}</div>
    </div>

    <div class="secao">
        <h2>Status do Momento (Ano ${rel.anoMomento})</h2>
        <div class="grafico">
            ${gerarBarra("Físico", rel.fisicoMomento, maxMom, 'fisico')}
            ${gerarBarra("Mental", rel.mentalMomento, maxMom, 'mental')}
            ${gerarBarra("Emocional", rel.emocionalMomento, maxMom, 'emocional')}
            ${gerarBarra("Intuitivo", rel.intuitivoMomento, maxMom, 'intuitivo')}
        </div>
        <p style="white-space:pre-line;">${rel.textoMomento}</p>

        <h3>Perfil de Expressão (Momento)</h3>
        <div class="grafico">
            ${gerarBarra("Criativo", rel.criativoMom, maxExpMom, 'criativo')}
            ${gerarBarra("Indeciso", rel.indecisoMom, maxExpMom, 'indeciso')}
            ${gerarBarra("Neutro", rel.neutroMom, maxExpMom, 'neutro')}
        </div>
        <div class="texto-grande">${rel.textoExpressaoMom}</div>
    </div>

    <div class="rodape">https://www.instintosuperior.com</div>
    `;

    setTimeout(() => { window.print(); }, 2000);
}

function gerarBarra(label, valor, max, classe) {
    const pct = Math.round((valor / max) * 100) || 0;
    // Para mostrar o número reduzido na label
    const reduzido = valor > 9 ? valor.toString().split("").reduce((a,b)=>a + Number(b),0) : valor;
    // Se for Tabela 3, mostramos o valor bruto, se for planos, o reduzido
    const valorExibido = (classe === 'criativo' || classe === 'indeciso' || classe === 'neutro') ? valor : reduzido;

    return `
        <div class="barra">
            <span>${label}: ${valorExibido}</span>
            <div class="linha"><div class="preenchimento ${classe}" style="width:${pct}%"></div></div>
        </div>`;
}
</script>
</body>
</html>
